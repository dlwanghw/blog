
## 前言

要理解性能优化的相关内容，需要了解Flutter的三棵树原理、可以查看[61.Flutter渲染管线](file:///../61.Flutter渲染管线.md)

## 性能优化的基本原理

列表滑动等动画流畅度的原理：是以一定频率（60hz下16.6ms）和不同 offset 计算出一系列静止画面，使其均匀的做画面切换，从而导致肉眼的视觉残象产生的错觉——而误以为图画或物体在流畅的运动/切换

所以定义流畅度可以从以下三个指标来评估：

* 平均 FPS：定义一次检测的平均帧率。反应画面平均停留时长。
* 1s 大卡顿次数：平均 1s 内出现占用 3 帧及以上的画面次数。反应画面停留时长跳变
* offset 跳变值：在画面不掉帧的情况，若其中一个画面出现跳变，甚至花屏或者绿屏会让用户体验到不流畅。在 APP 滑动过程中，画面内容由 offset 决定，而 offset 跳变，和卡顿时长、差值器实现均有关联，现有差值器实现基本基于 D/T 曲线（距离/时间），为此平均 FPS 和 1s 大卡顿次数很大程度上体现了画面跳变,所以可以忽略。

所以主要指标可以是：`平均 FPS` 和 `1S 内大的卡顿次数`


从 GUI 系统性能优化的一般方法来思考问题，即考虑一帧画面的绘制过程：

数据获取 --> 数据计算 --> 更新视图 --> 视图布局 --> 视图重绘 --> 视图渲染上屏

* **多线程方案** 这在 Android 原生开发中很常见。其基本思路是将 `数据获取 --> 数据计算` 这两部分分解到UI主线程之外的其他线程来做，充分利用多核优势。比如访问网络，比如读写sd卡。像这类操作大家都会很自然的想到使用子线程来完成耗时的操作，等操作结束之后，再通过Handler通知主线程进行界面的更新。在 dart 世界中，不同线程（isolate）的内存是隔离的，所以其用法会稍有不同，使用时要调查。

* **优化每个任务**，上面的主流程中，更新视图、视图布局、视图重绘都要在UI主线程完成，其目的都是要保证一帧时间（16.6 ms）完成任务。这是 flutter 中的主流优化思路，其主要的方向是两个：1是局部刷新，2是去除每一帧中的重复运算。
  
* **快速响应用户，让用户觉得够快，不阻塞用户的交互** 即一帧时间内还有任务没有完成，则停止执行，保证列表先执行滑动，未执行任务在后续帧时间片上执行。其具体做法一般是对数据进行分级，结合数据的`重要程度`和数据`获取的速度`综合分析，对于当前帧未能获取的数据，使用占位苻的方式来优先保证用户的事件响应和基本页面描画。

## Flutter性能优化技巧

从网上搜集汇总了flutter 性能优化相关的优秀文章提到的一些技巧：

**缩小刷新范围**

* setState 状态刷新位置尽量放置于视图树的低层级
* Provider 中获取 Model 的方式会影响刷新范围。推荐使用 Selector 或 Consumer 来获取祖先 Model，以维持最小刷新范围
* 对于频繁更新的控件（如动画），使用 RepaintBoundary 隔离它，创建单独 layer 减少重绘区域


**减少重复运算**

* 使用 `const` 修饰无需变更的 widget 或普通对象:减少build
* 列表 Item 高度可知的情况下，推荐设置 itemExtent，减少滑动中频繁计算列表高度
* 减少 saveLayer（ShaderMask、ColorFilter、Text Overflow）、clipPath的使用，提升 render 线程性能：减少渲染
* 避免在动画中剪裁。如果可能，请在动画开始之前预先剪切图像：减少paint
* 避免使用 Opacity widget，尤其是在动画中避免使用。请用 AnimatedOpacity 或 FadeInImage 进行代替：减少paint
* 使用 AnimatedBuilder 时，避免在不依赖于动画的 widget 的构造方法中构建 widget 树。动画的每次变动都会重建这个 widget 树。而应该构建子树的那一部分，并将其作为 child 传递给 AnimatedBuilder:减少build
* 避免使用带换行符的长文本:减少layout
* 减少或延迟 widget build 中非视图逻辑，如曝光埋点延迟到滑动停止聚合触发
* 对于长列表，避免使用 ListView() 构造函数，推荐使用 ListView.builder 构造函数：


**利用 Debug flags 排查问题**

flutter内置了多个调试用开关，可用来查看build、layout、paint、gpu的每帧数据

推荐 [Flutter Performance 分析工具简介](https://www.sunmoonblog.com/2020/01/10/flutter-performance-tools/)


---
参考资料
[他把闲鱼APP长列表流畅度翻了倍](https://zhuanlan.zhihu.com/p/269795712)


