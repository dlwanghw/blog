## 大规模使用Flutter需要准备的几点措施

1. 建立自动化的CI、CD流程，更好的情况下是和任务管理系统配合，这样可以自动化生成任务完成状态表。做到任务管理透明化，如果再将自动测试的结果关联起来，则可以做到质量的透明化。
2. 给开发人员的一揽子方案：热重载、debugger、日志获取
3. 单纯使用Flutter会遇到的典型用例的实现方案检讨：
   * 复杂UI场景(如Flutter和复杂的视频/图像/动画混合)
   * 后台需要长时间处理的操作，前端如何处理
   * 复杂的UI-如导航地图的实现思路
   * UI主色调模式变更-比如黑夜模式
4. 混合应用Flutter和原生会遇到的场景：
   1. 如果在一个已经存在的App中加入Flutter，如何让Native与Flutter进行无缝的衔接，同时保证相互开发之间的隔离性
   2. 如果在Flutter的容器中，使用已有的Native UI组件，在Flutter与Native渲染机制不同的情况下，怎么保证两者的无缝衔接以及高性能
5. Flutter大规模使用场景下的编程模式范例化，即如何在工程庞大的时候，控制每个应用/页面的复杂度，保持开发人员的低学习成本和均一的代码质量(备选方案：Component/Redux/Bloc...）如果要抽象出component，component间的通信方式、 component间的依赖关系定义
6. Flutter自定义组件的方法，为了将来官方组件不满足需求的情况下自定义组件的场合
7. Flutter性能调优的准备--Flutter渲染原理与优化
8. Flutter监控：
   * 内存使用量监控
   * LayerTree生成->Composite的分阶段执行时间监控
9. Flutter多个Isolate的通信，多个isolate的适用场景，其通信方式是什么样的
10. FlutterEngine的多实例问题：在未来的架构中是使用一个flutterengine实例，还是启动多个，如果复用一个就会有适配要求，如果是多个就会产生大内存需求
11. 编译时间会随着工程量的扩大以及和原生混合而快速增加，如何有效控制
12. 应用中日志埋点的设计和实现方案
13. Sample应用重要改造的问题：
    1. Service概念抽取-分离出来
    2. EventBus改造-页面间/组件间通信机制检讨
    3. 接口的可配置性--(访问websocket接口的IP/Port等是可以配置的)
    4. MVVM架构模式导入
    5. 流行的响应式编程的理念检讨



---

头脑风暴会

快速开发，快速调试，CI/CD的环境、代码静态检查、`脚手架`、自动化/UI自动化框架

Flutter的定位：isolate的使用，是多个还是一个？

* 从systemUI和app的在多个图层，同时显示在屏幕的应用场景出发，Flutter需要调查：
  * Flutter的渲染-图层选择、原点设定
  * Flutter的Isolate间通信机制
  * Flutter-engine多实例的管理
* 从Designe到代码描画的方式方法。Flutter的UIDesign→FlutterUICode的便利化方法
* 典型场景：
  * 音声割入的场景。
  * 需要长时间等待的操作。
  * 部品的动画实现，期待实现的动画和实际能够支持的动画的对比，逐一检讨可行性
  * MMP的画面的List实现-比如某个选项没有，处于下方的会自动往上移动并占位显示。类似的场景如何实现。
  * 









---

<参考资料>

从4月份开始尝试在业务侧接入flutter到现在，闲鱼在线上已经有10+的页面使用了flutter进行开发，其中覆盖了核心主链路发布和详情。



![img](https://pic4.zhimg.com/80/v2-93b0982abe5d24d0c2804b628784a573_720w.jpg)



闲鱼目前是市场上最大的闲置交易社区，作为一款有巨大用户体量的C端创新类产品，我们对体验以及研发迭代效率都有比较高的要求。在享受flutter带来的收益的过程中，同样会面临技术转型过程中的一些挑战。主要的挑战来源于以下的三个方面

- 工程体系

在现有工程体系下如何将flutter体系融入，并保持团队不同技术栈（Android/iOS/Flutter）的同学能各自独立高效进行开发。

- 业务架构

如何提供一套flutter之上的业务架构，保证上层代码的统一标准，同时尽可能的使得代码的复用度及隔离性更好。

- 基础中间件

如何保证不同技术栈背后使用的基础能力是一致的（底层统一使用具有相同优化策略的图片库/音视频库），且在这个过程中如何解决flutter融入后产生的问题。

面对这些挑战，闲鱼团队在下半年开始了针对基础设施的改造与重建。

## 基础设施重建之路

## 工程体系



![img](https://pic3.zhimg.com/80/v2-721aef7750ee83fd6ddbd2a07d8dfe46_720w.jpg)

工程体系部分，首当其冲需要考虑的是不同技术栈同学的协同问题，举例说明，我们的详情和发布页面是flutter的，而首页以及搜索部分目前暂时采用native进行开发。这就需要考虑到flutter的环境要对开发native的同学透明，甚至在native同学没有安装flutter环境的情况下，依然可以保持原来的方式进行开发native页面。

如图中所示，以iOS为例，我们针对flutter的框架flutter.framewrok和业务代码App.framework通过持续集成服务进行打包并自动上传至云端的pod repo上，native同学只需在Podfile内指定对应的两个库的版本即可，同理，针对flutter的plugin代码，同样打包上传至pod repo即可。

这套体系整体不复杂，需要说明的是，由于多人开发flutter工程，因此打包是一件非常频繁的事情，因此我们这半年构建了持续集成体系来帮助大家将打包上传等整个体系做成一键式服务，另外，由于原有iOS平台的flutter产物是需要依赖我们的native主工程的代码的，这种默认的打包方式，代码量巨大，造成持续集成时间在10-20分钟不等，因此在这个过程中，闲鱼团队通过直接基于xcode_backend.sh + insert_dylib的自定义脚本完成了不依赖native主工程源码的打包，将持续集成时间降至2分半。同理在android上面，也进行了一些基础的改造，感兴趣的同学可以给我们留言，我们会根据大家的需求程度在后续安排贡献给flutter社区。 

![img](https://pic2.zhimg.com/80/v2-7f74f95503683dc9b93fddaa80f2ed71_720w.jpg)

另外一部分比较重要的内容是混合栈相关的，由于flutter没有提供flutter到混合工程的最佳实践，所以我们在上半年自建了一整套混合栈的体系，这里主要是分享一些混合栈的关键思考，在混合栈的实现过程中，需重点测试验证dart这一侧widget的生命周期，并简化堆栈的管理（目前闲鱼的做法是将堆栈管理统一交由native进行控制，简化Dart层API），并需要考虑如何兼容Dart上层的比如Navigtor API的调用。整体这部分闲鱼团队还在验证当中，总之，这部分看似简单，但实际是比较深的坑，需要重点优化。另外，截至发文时间前，我们跟google flutter团队就混合栈交换了一些看法，flutter团队后续如果可以提供多flutterview，单flutter engine的基础能力，就可以使得闲鱼现有的混合栈实现成本整体大幅度降低，后续大家有什么特别好的建议，也欢迎跟我们进行交流。

## 业务架构



![img](https://pic2.zhimg.com/80/v2-91edf0a27a118fc7b638781dae24fefd_720w.jpg)

今年下半年由于有更多的业务迁移至flutter，这意味着更多的团队成员开始了Dart侧的研发。很快我们发现团队的代码风格，层次结构都比较混乱，bug也层出不穷，因此我们需要找到一种可以保证大家研发规范，同时确保多人协同过程中，代码既能更好的复用，又可以在适当的场景下做到相互隔离的这么一种方案。

在经过社区的多个框架库的实践和比较以后，不管是flex还是redux都不能完全解决我们的问题。最后我们选择了自己进行设计和实现，我们对框架进行基础分层以后，将重点最终落在了基于单一数据源的组件化框架上面，因此我们产生了自己的框架fishRedux，我们严格参考标准js的redux规范和源码（redux的设计三原则）进行了完整的dart侧的实现，并在此基础上提供扩展能力用于我们的组件化开发。



![img](https://pic2.zhimg.com/80/v2-55e9de596c936d2f36ad22a881f27c4d_720w.jpg)

如图所示，component将redux中的view，reducer，middleware以及我们的扩展能力effect进行组装，从而可以在不同的页面进行组件的复用，当然，全局依然遵循redux的单一数据源的原则，但我们将逻辑本身通过更细粒度的拆解，保证了这些逻辑在不同的component组装下都可以尽可能的进行复用。 基于这种结构，我们可以将任意的component进行挂载和拼装，通过更多小粒度的组件，产生不同场景下的复杂页面。 

![img](https://pic1.zhimg.com/80/v2-5df3334132df42bbe9da2769ed30154c_720w.jpg)

另外，针对于component的多层组装，大家可以细看下dependents这个字段，通过基于这个字段的组装，在我们提供的这段代码里面，实际上是提供了一个详情页面的插槽的功能，详情页面目前在闲鱼有近10种不同的组合，在这个场景下，可以在保证组件可以服用的同时，做到不同流程下的代码隔离。我们只要针对dependents的components里面进行替换，就可以很容易的达到在详情页面插入不同widget以及逻辑的效果。

fishRedux框架目前已经接近修改的尾声，目前还有部分微调和文档的补充，明年4月份前，我们有计划进行该框架的开源，为后续业务架构提供一个新的标准，大家敬请期待。

## 基础中间件



![img](https://pic1.zhimg.com/80/v2-0cc9f7f30f30379d0d7c9def90d2e2ac_720w.jpg)

在阿里集团内部，已经产出了较多的基础中间件，因此如何复用这个中间件到flutter侧是一个新的挑战，针对于传统的比如网络库，crash收集等中间件，由于不涉及到UI的复用，相对容易，但针对音视频，图片库等这类的中间件，虽然flutter提供了flutterTexture的方案，但依然不是特别完美。 

![img](https://pic2.zhimg.com/80/v2-06f235b91dda6f36c51f9f924823372d_720w.jpg)

我们在做音视频及图片库的复用过程中，主要的问题在于flutter原生提供的机制，针对图片的渲染存在GPU到CPU，然后CPU再到GPU的这样一个过程，如图所示。根本原因在于不同的glContext无法共享texture。因此，我们目前采取的方案是修改flutter引擎，并暴露出glContext的shareGroup（以iOS为例）。目前整个方案已经上线。 

![img](https://pic2.zhimg.com/80/v2-f0805cf8213ac49a3fbf5c98cb281d31_720w.jpg)

由于该改动目前在闲鱼自己fork的engine里面，因此目前将我们之前踩到的一些坑同步给大家，如果大家有在flutter和native侧同时使用音视频的情况，建议特别注意ppt中的前两点，否则会造成flutter侧或者native侧音视频的错乱。当然如果按照闲鱼团队的提供的修改方案进行engine改造后，也可以通过第三点，对native设置跟flutter相同的sharegroup来解决这个问题。在flutter live Beijing结束之后，我也将该方案正式介绍给google flutter团队，希望后续能将类似的功能融入flutter的官方实现。

## 闲鱼与flutter社区



![img](https://pic2.zhimg.com/80/v2-ed2fd5805f7981126e45c429bc42bd59_720w.jpg)

闲鱼这半年，对于flutter社区，也有一些小小的贡献。我们针对flutter的方案进行整理并在各个技术社区进行传播。另外我们将已有的一些问题和解决方案提供给google flutter官方团队，直接或者间接的推动了flutter的整体进度，并改变了这个技术未来的部分走向。我为自己的团队感到由衷的骄傲，但同时我意识到，要想让flutter成为终端未来的主流技术，依然任重道远，因此我们后续也会将目前的一些相对稳定的框架和解决方案，逐步开源到社区，我们的要求是，至少闲鱼团队需要在线上有应用和验证。目前我们已经有一些初步的demo和小工具放在上面，大家感兴趣的可以往我们的[github](https://link.zhihu.com/?target=https%3A//github.com/alibaba-flutter)上提issue，我们后续会逐步开放更多的代码。最近会公布的比较重要的框架会是fishRedux，因此请大家持续关注我们。

## 总结与展望

我们首先带大家回顾了flutter带来的优势以及在闲鱼的实际例子，并引出在复杂工程下的一些挑战。我们针对这些挑战，在下半年进行了整个体系的重新建设，初步完成了 - 隔离的混合工程体系 - 统一标准的业务架构 - 高效复用基础中间件设施

本次的分享，其实只是我们目前团队的一部分内容，我们基于flutter和dart还有更多的技术方案目前在预研和研发中，所以没有在这次live中进行宣讲。在后续跟google flutter团队的沟通中也了解到，他们对我们的多个方案都有较大的兴趣。对于未来来说，一方面，除了本文分享的内容以外，我们自己在代码自动生成/Dart Server/线上问题自动回放/国际化/动态模版等/持续集成等多个方面都在持续关注和调研。另一方面，在flutter 1.0公布后，类似hummingbrid这一类全新的方案也有机会让flutter具有全终端制霸的可能性，我们也会持续跟进和进行尝试。Anyway，依然希望有更多的同学可以加入我们一起完善flutter的生态，同时通过新的技术手段，让天下没有闲置。来闲鱼一起改变世界吧，少年！